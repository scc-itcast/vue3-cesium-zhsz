{"version":3,"file":"index.js","sources":["../../../../../../packages/components/primitive-collections/primitive-collection/index.ts"],"sourcesContent":["/*\n * @Author: zouyaoji@https://github.com/zouyaoji\n * @Date: 2021-09-16 09:28:13\n * @LastEditTime: 2022-03-28 10:04:35\n * @LastEditors: zouyaoji\n * @Description:\n * @FilePath: \\vue-cesium@next\\packages\\components\\primitive-collections\\primitive-collection\\index.ts\n */\nimport type { ExtractPropTypes, PropType, VNode, WatchStopHandle } from 'vue'\nimport { createCommentVNode, defineComponent, getCurrentInstance, h, onUnmounted, watch } from 'vue'\nimport type { VcComponentInternalInstance, VcComponentPublicInstance } from '@vue-cesium/utils/types'\nimport { usePrimitiveCollections } from '@vue-cesium/composables'\nimport { show, enableMouseEvent } from '@vue-cesium/utils/cesium-props'\nimport { addCustomProperty, kebabCase } from '@vue-cesium/utils/util'\nimport { hSlot } from '@vue-cesium/utils/private/render'\nimport { cloneDeep, differenceBy } from 'lodash-unified'\nimport { PolygonPrimitive } from '@vue-cesium/shared'\nimport { primitiveCollectionEmits } from '@vue-cesium/utils/emits'\nimport { VcPolygonProps } from '../polygon'\n\nexport const primitiveCollectionProps = {\n  ...show,\n  destroyPrimitives: {\n    type: Boolean,\n    default: true\n  },\n  ...enableMouseEvent,\n  polygons: {\n    type: Array as PropType<Array<VcPolygonProps>>,\n    default: () => []\n  }\n}\nexport default defineComponent({\n  name: 'VcCollectionPrimitive',\n  props: primitiveCollectionProps,\n  emits: primitiveCollectionEmits,\n  setup(props, ctx) {\n    // state\n    const instance = getCurrentInstance() as VcComponentInternalInstance\n    instance.cesiumClass = 'PrimitiveCollection'\n    const primitiveCollectionsState = usePrimitiveCollections(props, ctx, instance)\n\n    if (primitiveCollectionsState === void 0) {\n      return\n    }\n\n    // watcher\n    instance.alreadyListening.push('polygons')\n    let unwatchFns: Array<WatchStopHandle> = []\n\n    unwatchFns.push(\n      watch(\n        () => cloneDeep(props.polygons),\n        (newVal, oldVal) => {\n          if (!instance.mounted) {\n            return\n          }\n          const primitiveCollection = instance.cesiumObject as Cesium.PrimitiveCollection\n\n          if (newVal.length === oldVal.length) {\n            // 视为修改操作\n            // Treated as modified\n            const modifies: Array<any> = []\n            for (let i = 0; i < newVal.length; i++) {\n              const options = newVal[i]\n              const oldOptions = oldVal[i]\n\n              if (JSON.stringify(options) !== JSON.stringify(oldOptions)) {\n                modifies.push({\n                  newOptions: options,\n                  oldOptions: oldOptions\n                })\n              }\n            }\n\n            modifies.forEach(modify => {\n              const modifyPolygon = primitiveCollection._primitives.find(v => v._id === modify.oldOptions.id)\n              modifyPolygon &&\n                Object.keys(modify.newOptions).forEach(prop => {\n                  if (modify.oldOptions[prop] !== modify.newOptions[prop]) {\n                    modifyPolygon[prop] = primitiveCollectionsState.transformProp(prop, modify.newOptions[prop])\n                  }\n                })\n            })\n          } else {\n            const addeds: any = differenceBy(newVal, oldVal, 'id')\n            const deletes: any = differenceBy(oldVal, newVal, 'id')\n            const deletePolygons: Array<PolygonPrimitive> = []\n            for (let i = 0; i < deletes.length; i++) {\n              const deletePolygon = primitiveCollection._primitives.find((v: any) => v.id === deletes[i].id)\n              deletePolygon && deletePolygons.push(deletePolygon)\n            }\n\n            deletePolygons.forEach(v => {\n              primitiveCollection.remove(v)\n            })\n\n            addPolygons(primitiveCollection, addeds)\n          }\n        },\n        {\n          deep: true\n        }\n      )\n    )\n\n    // methods\n    const addPolygons = (primitiveCollection: Cesium.PrimitiveCollection, polygons) => {\n      for (let i = 0; i < polygons.length; i++) {\n        const polygonOptions = polygons[i] as PolygonPrimitive\n        polygonOptions.id = Cesium.defined(polygonOptions.id) ? polygonOptions.id : Cesium.createGuid()\n        const polygonOptionsTransform = primitiveCollectionsState.transformProps(polygonOptions)\n        const polygonPrimitive = new PolygonPrimitive(polygonOptionsTransform)\n        ;(polygonPrimitive as any)._vcParent = primitiveCollection\n        addCustomProperty(polygonPrimitive, polygonOptionsTransform)\n        primitiveCollection.add(polygonPrimitive)\n      }\n    }\n\n    instance.createCesiumObject = async () => {\n      const options = primitiveCollectionsState.transformProps(props)\n      const primitiveCollection = new Cesium.PrimitiveCollection(options)\n      addPolygons(primitiveCollection, props.polygons)\n      return primitiveCollection\n    }\n\n    // life cycle\n    onUnmounted(() => {\n      unwatchFns.forEach(item => item())\n      unwatchFns = []\n    })\n\n    const name = instance.proxy?.$options.name || ''\n    return () =>\n      ctx.slots.default\n        ? h(\n            'i',\n            {\n              class: kebabCase(name),\n              style: { display: 'none !important' }\n            },\n            hSlot(ctx.slots.default)\n          )\n        : createCommentVNode(kebabCase(name))\n  }\n})\n\nexport type VcCollectionPrimitiveProps = {\n  /**\n   * Determines if the primitives in the collection will be shown.\n   * Default value: true\n   */\n  show?: boolean\n  /**\n   * Determines if primitives in the collection are destroyed when they are removed.\n   * Default value: true\n   */\n  destroyPrimitives?: boolean\n  /**\n   * Specifies whether to respond to mouse pick events.\n   * Default Value: true\n   */\n  enableMouseEvent?: boolean\n  /**\n   * Specify an array of polygons collections. The structure of the array object is the same as the attribute of the [`vc-polygon`](https://zouyaoji.top/vue-cesium/#/en-US/component/primitives/vc-collection-primitive#vcpolygon-props) component.\n   */\n  polygons?: Array<VcPolygonProps>\n}\n\nexport type VcCollectionPrimitiveRef = VcComponentPublicInstance<VcCollectionPrimitiveProps>\n\nexport interface VcCollectionPrimitiveSlots {\n  /**\n   * This is where Primitive content goes.\n   */\n  default: () => VNode[]\n}\n"],"names":["show","enableMouseEvent","defineComponent","primitiveCollectionEmits","getCurrentInstance","usePrimitiveCollections","watch","cloneDeep","differenceBy","PolygonPrimitive","addCustomProperty","onUnmounted","h","kebabCase","hSlot","createCommentVNode"],"mappings":";;;;;;;;;;;;;;;AAQY,MAAC,wBAAwB,GAAG;AACxC,EAAE,GAAGA,gBAAI;AACT,EAAE,iBAAiB,EAAE;AACrB,IAAI,IAAI,EAAE,OAAO;AACjB,IAAI,OAAO,EAAE,IAAI;AACjB,GAAG;AACH,EAAE,GAAGC,4BAAgB;AACrB,EAAE,QAAQ,EAAE;AACZ,IAAI,IAAI,EAAE,KAAK;AACf,IAAI,OAAO,EAAE,MAAM,EAAE;AACrB,GAAG;AACH,EAAE;AACF,0BAAeC,mBAAe,CAAC;AAC/B,EAAE,IAAI,EAAE,uBAAuB;AAC/B,EAAE,KAAK,EAAE,wBAAwB;AACjC,EAAE,KAAK,EAAEC,8BAAwB;AACjC,EAAE,KAAK,CAAC,KAAK,EAAE,GAAG,EAAE;AACpB,IAAI,IAAI,EAAE,CAAC;AACX,IAAI,MAAM,QAAQ,GAAGC,sBAAkB,EAAE,CAAC;AAC1C,IAAI,QAAQ,CAAC,WAAW,GAAG,qBAAqB,CAAC;AACjD,IAAI,MAAM,yBAAyB,GAAGC,gBAAuB,CAAC,KAAK,EAAE,GAAG,EAAE,QAAQ,CAAC,CAAC;AACpF,IAAI,IAAI,yBAAyB,KAAK,KAAK,CAAC,EAAE;AAC9C,MAAM,OAAO;AACb,KAAK;AACL,IAAI,QAAQ,CAAC,gBAAgB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;AAC/C,IAAI,IAAI,UAAU,GAAG,EAAE,CAAC;AACxB,IAAI,UAAU,CAAC,IAAI,CAACC,SAAK,CAAC,MAAMC,uBAAS,CAAC,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,MAAM,EAAE,MAAM,KAAK;AAC/E,MAAM,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;AAC7B,QAAQ,OAAO;AACf,OAAO;AACP,MAAM,MAAM,mBAAmB,GAAG,QAAQ,CAAC,YAAY,CAAC;AACxD,MAAM,IAAI,MAAM,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,EAAE;AAC3C,QAAQ,MAAM,QAAQ,GAAG,EAAE,CAAC;AAC5B,QAAQ,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAChD,UAAU,MAAM,OAAO,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;AACpC,UAAU,MAAM,UAAU,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;AACvC,UAAU,IAAI,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,EAAE;AACtE,YAAY,QAAQ,CAAC,IAAI,CAAC;AAC1B,cAAc,UAAU,EAAE,OAAO;AACjC,cAAc,UAAU;AACxB,aAAa,CAAC,CAAC;AACf,WAAW;AACX,SAAS;AACT,QAAQ,QAAQ,CAAC,OAAO,CAAC,CAAC,MAAM,KAAK;AACrC,UAAU,MAAM,aAAa,GAAG,mBAAmB,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,GAAG,KAAK,MAAM,CAAC,UAAU,CAAC,EAAE,CAAC,CAAC;AAC5G,UAAU,aAAa,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,OAAO,CAAC,CAAC,IAAI,KAAK;AAC5E,YAAY,IAAI,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,KAAK,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE;AACrE,cAAc,aAAa,CAAC,IAAI,CAAC,GAAG,yBAAyB,CAAC,aAAa,CAAC,IAAI,EAAE,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC;AAC3G,aAAa;AACb,WAAW,CAAC,CAAC;AACb,SAAS,CAAC,CAAC;AACX,OAAO,MAAM;AACb,QAAQ,MAAM,MAAM,GAAGC,0BAAY,CAAC,MAAM,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;AAC1D,QAAQ,MAAM,OAAO,GAAGA,0BAAY,CAAC,MAAM,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;AAC3D,QAAQ,MAAM,cAAc,GAAG,EAAE,CAAC;AAClC,QAAQ,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACjD,UAAU,MAAM,aAAa,GAAG,mBAAmB,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,OAAO,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;AACpG,UAAU,aAAa,IAAI,cAAc,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;AAC9D,SAAS;AACT,QAAQ,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK;AACtC,UAAU,mBAAmB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;AACxC,SAAS,CAAC,CAAC;AACX,QAAQ,WAAW,CAAC,mBAAmB,EAAE,MAAM,CAAC,CAAC;AACjD,OAAO;AACP,KAAK,EAAE;AACP,MAAM,IAAI,EAAE,IAAI;AAChB,KAAK,CAAC,CAAC,CAAC;AACR,IAAI,MAAM,WAAW,GAAG,CAAC,mBAAmB,EAAE,QAAQ,KAAK;AAC3D,MAAM,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAChD,QAAQ,MAAM,cAAc,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;AAC3C,QAAQ,cAAc,CAAC,EAAE,GAAG,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE,CAAC,GAAG,cAAc,CAAC,EAAE,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;AACxG,QAAQ,MAAM,uBAAuB,GAAG,yBAAyB,CAAC,cAAc,CAAC,cAAc,CAAC,CAAC;AACjG,QAAQ,MAAM,gBAAgB,GAAG,IAAIC,2BAAgB,CAAC,uBAAuB,CAAC,CAAC;AAC/E,QAAQ,gBAAgB,CAAC,SAAS,GAAG,mBAAmB,CAAC;AACzD,QAAQC,sBAAiB,CAAC,gBAAgB,EAAE,uBAAuB,CAAC,CAAC;AACrE,QAAQ,mBAAmB,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;AAClD,OAAO;AACP,KAAK,CAAC;AACN,IAAI,QAAQ,CAAC,kBAAkB,GAAG,YAAY;AAC9C,MAAM,MAAM,OAAO,GAAG,yBAAyB,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;AACtE,MAAM,MAAM,mBAAmB,GAAG,IAAI,MAAM,CAAC,mBAAmB,CAAC,OAAO,CAAC,CAAC;AAC1E,MAAM,WAAW,CAAC,mBAAmB,EAAE,KAAK,CAAC,QAAQ,CAAC,CAAC;AACvD,MAAM,OAAO,mBAAmB,CAAC;AACjC,KAAK,CAAC;AACN,IAAIC,eAAW,CAAC,MAAM;AACtB,MAAM,UAAU,CAAC,OAAO,CAAC,CAAC,IAAI,KAAK,IAAI,EAAE,CAAC,CAAC;AAC3C,MAAM,UAAU,GAAG,EAAE,CAAC;AACtB,KAAK,CAAC,CAAC;AACP,IAAI,MAAM,IAAI,GAAG,CAAC,CAAC,EAAE,GAAG,QAAQ,CAAC,KAAK,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,QAAQ,CAAC,IAAI,KAAK,EAAE,CAAC;AACnF,IAAI,OAAO,MAAM,GAAG,CAAC,KAAK,CAAC,OAAO,GAAGC,KAAC,CAAC,GAAG,EAAE;AAC5C,MAAM,KAAK,EAAEC,cAAS,CAAC,IAAI,CAAC;AAC5B,MAAM,KAAK,EAAE,EAAE,OAAO,EAAE,iBAAiB,EAAE;AAC3C,KAAK,EAAEC,YAAK,CAAC,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,GAAGC,sBAAkB,CAACF,cAAS,CAAC,IAAI,CAAC,CAAC,CAAC;AACvE,GAAG;AACH,CAAC,CAAC;;;;;"}