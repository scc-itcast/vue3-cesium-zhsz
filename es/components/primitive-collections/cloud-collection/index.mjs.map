{"version":3,"file":"index.mjs","sources":["../../../../../../packages/components/primitive-collections/cloud-collection/index.ts"],"sourcesContent":["/*\n * @Author: zouyaoji@https://github.com/zouyaoji\n * @Date: 2022-01-28 10:49:53\n * @LastEditTime: 2022-03-20 00:06:02\n * @LastEditors: zouyaoji\n * @Description:\n * @FilePath: \\vue-cesium@next\\packages\\components\\primitive-collections\\cloud-collection\\index.ts\n */\nimport type { PropType, WatchStopHandle } from 'vue'\nimport { createCommentVNode, defineComponent, getCurrentInstance, h, onUnmounted, watch } from 'vue'\nimport type { VcComponentInternalInstance, VcComponentPublicInstance, VcPosition, VcReadyObject } from '@vue-cesium/utils/types'\nimport { usePrimitiveCollections } from '@vue-cesium/composables'\nimport { cloneDeep, differenceBy } from 'lodash-unified'\nimport { show } from '@vue-cesium/utils/cesium-props'\nimport { addCustomProperty, kebabCase } from '@vue-cesium/utils/util'\nimport { hSlot } from '@vue-cesium/utils/private/render'\nimport { commonEmits } from '@vue-cesium/utils/emits'\nimport type { VcCumulusCloudProps } from '../cloud'\nimport VcCumulusCloud from '../cloud'\n\nexport const cloudCollectionProps = {\n  ...show,\n  noiseDetail: {\n    type: Number,\n    default: 16.0\n  },\n  noiseOffset: {\n    type: Object as PropType<VcPosition>\n  },\n  debugBillboards: {\n    type: Boolean,\n    default: false\n  },\n  debugEllipsoids: {\n    type: Boolean,\n    default: false\n  },\n  clouds: {\n    type: Array as PropType<Array<VcCumulusCloudProps>>,\n    default: () => []\n  }\n}\nexport default defineComponent({\n  name: 'VcCollectionCloud',\n  props: cloudCollectionProps,\n  emits: commonEmits,\n  setup(props, ctx) {\n    // state\n    const instance = getCurrentInstance() as VcComponentInternalInstance\n    instance.cesiumClass = 'CloudCollection'\n    const primitiveCollectionsState = usePrimitiveCollections(props, ctx, instance)\n\n    if (primitiveCollectionsState === void 0) {\n      return\n    }\n\n    // watcher\n    instance.alreadyListening.push('clouds')\n    let unwatchFns: Array<WatchStopHandle> = []\n    unwatchFns.push(\n      watch(\n        () => cloneDeep(props.clouds),\n        (newVal, oldVal) => {\n          if (!instance.mounted) {\n            return\n          }\n\n          const cloudCollection = instance.cesiumObject as Cesium.CloudCollection\n\n          if (newVal.length === oldVal.length) {\n            // 视为修改操作\n            // Treated as modified\n            const modifies: Array<any> = []\n            for (let i = 0; i < newVal.length; i++) {\n              const options = newVal[i]\n              const oldOptions = oldVal[i]\n\n              if (JSON.stringify(options) !== JSON.stringify(oldOptions)) {\n                modifies.push({\n                  newOptions: options,\n                  oldOptions: oldOptions\n                })\n              }\n            }\n\n            modifies.forEach(modify => {\n              const modifyCloud = cloudCollection._clouds.find(v => v.id === modify.oldOptions.id)\n              modifyCloud &&\n                Object.keys(modify.newOptions).forEach(prop => {\n                  if (modify.oldOptions[prop] !== modify.newOptions[prop]) {\n                    modifyCloud[prop] = primitiveCollectionsState.transformProp(prop, modify.newOptions[prop])\n                  }\n                })\n            })\n          } else {\n            const addeds: any = differenceBy(newVal, oldVal, 'id')\n            const deletes: any = differenceBy(oldVal, newVal, 'id')\n            const deleteClouds: Array<Cesium.CumulusCloud> = []\n            for (let i = 0; i < deletes.length; i++) {\n              const deleteCloud = cloudCollection._clouds.find(v => v.id === deletes[i].id)\n              deleteCloud && deleteClouds.push(deleteCloud)\n            }\n\n            deleteClouds.forEach(v => {\n              cloudCollection.remove(v)\n            })\n\n            addClouds(cloudCollection, addeds)\n          }\n        },\n        {\n          deep: true\n        }\n      )\n    )\n    // methods\n    const addClouds = (cloudCollection: Cesium.CloudCollection, clouds) => {\n      for (let i = 0; i < clouds.length; i++) {\n        const cloudOptions = clouds[i] as Cesium.CumulusCloud\n        cloudOptions.id = Cesium.defined(cloudOptions.id) ? cloudOptions.id : Cesium.createGuid()\n        const cloudOptionsTransform = primitiveCollectionsState.transformProps(cloudOptions, VcCumulusCloud.props)\n        const cloud = cloudCollection.add(cloudOptionsTransform)\n        addCustomProperty(cloud, cloudOptionsTransform)\n      }\n    }\n\n    instance.createCesiumObject = async () => {\n      const options = primitiveCollectionsState.transformProps(props, VcCumulusCloud.props)\n      const cloudCollection = new Cesium.CloudCollection(options as any)\n      addClouds(cloudCollection, props.clouds)\n      return cloudCollection\n    }\n\n    // life cycle\n    onUnmounted(() => {\n      unwatchFns.forEach(item => item())\n      unwatchFns = []\n    })\n\n    const name = instance.proxy?.$options.name || ''\n    return () =>\n      ctx.slots.default\n        ? h(\n            'i',\n            {\n              class: kebabCase(name),\n              style: { display: 'none !important' }\n            },\n            hSlot(ctx.slots.default)\n          )\n        : createCommentVNode(kebabCase(name))\n  }\n})\n\nexport type VcCollectionCloudProps = {\n  /**\n   * Whether to display the clouds.\n   * Default value: true\n   */\n  show?: boolean\n  /**\n   * Desired amount of detail in the noise texture.\n   * Default value: 16.0\n   */\n  noiseDetail?: number\n  /**\n   * Desired translation of data in noise texture.\n   * Default value: {x: 0, y: 0, z: 0}\n   */\n  noiseOffset?: VcPosition\n  /**\n   * For debugging only. Determines if the billboards are rendered with an opaque color.\n   * Default value: false\n   */\n  debugBillboards?: boolean\n  /**\n   * For debugging only. Determines if the clouds will be rendered as opaque ellipsoids.\n   * Default value: false\n   */\n  debugEllipsoids?: boolean\n  /**\n   * Specifies an array of cumulus collections. The array object structure is the same as the [vc-cumulus-cloud](https://zouyaoji.top/vue-cesium/#/en-US/component/primitives/vc-collection-cloud#vccumuluscloud-props) component properties.\n   */\n  clouds?: Array<VcCumulusCloudProps>\n  /**\n   * Triggers before the VcCollectionCloud is loaded.\n   */\n  onBeforeLoad?: (instance: VcComponentInternalInstance) => void\n  /**\n   * Triggers when the VcCollectionCloud is successfully loaded.\n   */\n  onReady?: (readyObject: VcReadyObject) => void\n  /**\n   * Triggers when the VcCollectionCloud is destroyed.\n   */\n  onDestroyed?: (instance: VcComponentInternalInstance) => void\n}\n\nexport type VcCollectionCloudRef = VcComponentPublicInstance<VcCollectionCloudProps>\n"],"names":["VcCumulusCloud"],"mappings":"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"}